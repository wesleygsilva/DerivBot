<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deriv Trading Bot</title>
<script src="/socket.io/socket.io.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0e0e0e;
    color: #e0e0e0;
    min-height: 100vh;
}


.btn-reset {
    background: #dc3545;
    color: white;
    margin-top: 8px;
}

.navbar {
    background: #1a1a1a;
    padding: 12px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #2a2a2a;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #ff2b2b 0%, #ee5a24 100%);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 18px;
}

.logo-text {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
}

.balance-display {
    background: #252525;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 16px;
}

.main-container {
    display: grid;
    grid-template-columns: 340px 1fr 280px;
    gap: 16px;
    padding: 16px;
    height: calc(100vh - 57px);
}

.left-panel, .right-panel {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 16px;
    overflow-y: auto;
}

.center-panel {
    background: #1a1a1a;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.panel-section {
    margin-bottom: 20px;
}

.panel-section:last-child {
    margin-bottom: 0;
}

.section-title {
    font-size: 11px;
    font-weight: 600;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.value-display {
    background: #252525;
    padding: 12px;
    border-radius: 6px;
    font-size: 20px;
    font-weight: 600;
    text-align: center;
}

.value-display.positive {
    color: #00d67a;
}

.value-display.negative {
    color: #ff4757;
}

.form-group {
    margin-bottom: 12px;
}

.form-group label {
    display: block;
    font-size: 12px;
    color: #aaa;
    margin-bottom: 6px;
}

.form-group select,
.form-group input {
    width: 100%;
    background: #252525;
    border: 1px solid #333;
    color: #e0e0e0;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
}

.form-group select:focus,
.form-group input:focus {
    outline: none;
    border-color: #00d67a;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
}

.btn {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 8px;
}

.btn:last-child {
    margin-bottom: 0;
}

.btn:hover:not(:disabled) {
    transform: translateY(-1px);
}

.btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.btn-connect {
    background: #007bff;
    color: white;
}

.btn-start {
    background: #00d67a;
    color: #0e0e0e;
}

.btn-stop {
    background: #ffc107;
    color: #0e0e0e;
}

.connection-status {
    padding: 8px;
    border-radius: 6px;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 12px;
}

.connection-status.connected {
    background: rgba(0, 214, 122, 0.1);
    color: #00d67a;
    border: 1px solid rgba(0, 214, 122, 0.3);
}

.connection-status.disconnected {
    background: rgba(255, 71, 87, 0.1);
    color: #ff4757;
    border: 1px solid rgba(255, 71, 87, 0.3);
}

.strategy-info {
    background: #252525;
    padding: 10px;
    border-radius: 6px;
    font-size: 12px;
    color: #aaa;
    margin-top: 8px;
}

.digits-section {
    padding: 16px;
    border-bottom: 1px solid #2a2a2a;
}

.digits-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.digits-header h3 {
    font-size: 14px;
    font-weight: 600;
    color: #fff;
}

.btn-clear {
    background: #333;
    color: #e0e0e0;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
}

.btn-clear:hover {
    background: #444;
}

.digits-display {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
}

.digit {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
}

.digit.even {
    background: #ffc107;
    color: #0e0e0e;
}

.digit.odd {
    background: #17a2b8;
    color: white;
}

.logs-section {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
}

.logs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.logs-header h3 {
    font-size: 14px;
    font-weight: 600;
    color: #fff;
}

.logs-actions {
    display: flex;
    gap: 8px;
}

.btn-download {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
}

.btn-download:hover {
    background: #138496;
}

.logs-container {
    max-height: 100%;
}

.log-entry {
    padding: 8px 12px;
    margin-bottom: 6px;
    border-radius: 4px;
    font-size: 12px;
    border-left: 3px solid #007bff;
    background: #252525;
}

.log-entry.success {
    background: rgba(0, 214, 122, 0.1);
    border-left-color: #00d67a;
    color: #00d67a;
}

.log-entry.error {
    background: rgba(255, 71, 87, 0.1);
    border-left-color: #ff4757;
    color: #ff4757;
}

.log-entry.warning {
    background: rgba(255, 193, 7, 0.1);
    border-left-color: #ffc107;
    color: #ffc107;
}

.log-entry.info {
    background: rgba(23, 162, 184, 0.1);
    border-left-color: #17a2b8;
    color: #17a2b8;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.stat-card {
    background: #252525;
    padding: 12px;
    border-radius: 6px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #00d67a;
}

.stat-label {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.input-help {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
}

@media (max-width: 1200px) {
    .main-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
    }
    
    .left-panel {
        order: 1;
    }
    
    .center-panel {
        order: 3;
        height: 600px;
    }
    
    .right-panel {
        order: 2;
    }
}

.inline-fields-group {
    display: flex;
    gap: 8px; /* Slightly smaller gap to save space */
}

.inline-fields-group .form-group {
    flex: 1;
    min-width: 80px; /* Reduced min-width */
    margin-bottom: 0;
}
</style>
</head>
<body>

<div class="navbar">
    <div class="logo">
        <div class="logo-icon">D</div>
        <span class="logo-text">DERIV BOT</span>
    </div>
    <div class="balance-display" id="navBalance">$0.00</div>
</div>

<div class="main-container">
    <!-- PAINEL ESQUERDO -->
    <div class="left-panel">
        <!-- Conexão -->
        <div class="panel-section">
            <div class="connection-status disconnected" id="connectionStatus">Desconectado</div>
        </div>


        <!-- Lucro/Prejuízo -->
        <!-- <div class="panel-section">
            <div class="section-title">Lucro/Prejuízo</div>
            <div class="value-display" id="profitDisplay">$0.00</div>
        </div> -->

        <!-- Mercado -->
        <div class="panel-section">
            <div class="section-title">Mercado</div>
            <div class="form-group">
                <select id="symbolSelector" onchange="changeSymbol()">
                    <option value="R_100">Volatility 100 Index</option>
                    <option value="R_75">Volatility 75 Index</option>
                    <option value="R_50">Volatility 50 Index</option>
                    <option value="R_25">Volatility 25 Index</option>
                    <option value="R_10">Volatility 10 Index</option>
                    <option value="1HZ100V">Volatility 100 (1s) Index</option>
                    <option value="1HZ75V">Volatility 75 (1s) Index</option>
                    <option value="1HZ50V">Volatility 50 (1s) Index</option>
                    <option value="1HZ25V">Volatility 25 (1s) Index</option>
                    <option value="1HZ10V">Volatility 10 (1s) Index</option>
                </select>
            </div>
        </div>

        <!-- Estratégia -->
        <div class="panel-section">
            <div class="section-title">Estratégia</div>
            <div class="form-group">
                <select id="strategySelector" onchange="changeStrategy()">
                    <option value="">Carregando...</option>
                </select>
            </div>
                        
            <div id="tradingModesContainer" class="form-group" style="display: none;">
                <label for="tradingModeSelector">Modo de Negociação</label>
                <select id="tradingModeSelector" onchange="changeTradingMode()">
                    <option value="">Manual</option>
                </select>
            </div>

            <!-- Configurações da Estratégia (inline) -->
            <div style="margin-top: 16px;" id="strategyConfigContainer">
                <div id="strategyConfigFields"></div>
            </div>
        </div>

        <!-- Configurações Comuns -->
        <div class="panel-section">
            <div class="section-title">Configurações Comuns</div>
            <div class="form-group">
                <label for="riskManagement">Gerenciamento de Risco</label>
                <select id="riskManagement">
                    <option value="1">Fixo</option>
                    <option value="2.8">Conservador</option>
                    <option value="3" selected>Otimizado</option>
                    <option value="3.2">Agressivo</option>
                </select>
            </div>
            <div class="inline-fields-group">
                <div class="form-group">
                    <label for="baseStake">Stake Inicial</label>
                    <input type="number" id="baseStake" value="0.35" min="0.35" step="0.01">
                </div>
                <div class="form-group">
                    <label for="profitGoal">Lucro Alvo</label>
                    <input type="number" id="profitGoal" value="10.00" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="maxMartingale">Limite de Perda</label>
                    <input type="number" id="maxMartingale" value="6" min="1" max="15">
                </div>
            </div>
        </div>
        <div class="panel-section">
            <button class="btn btn-start" onclick="startBot()" id="startBtn" disabled>Iniciar Bot</button>
            <button class="btn btn-stop" onclick="stopBot()" id="stopBtn" disabled>Pausar Bot</button>
        </div>
    </div>

    <!-- PAINEL CENTRAL -->
    <div class="center-panel">
        <!-- Dígitos -->
        <div class="digits-section">
            <div class="digits-header">
                <h3>DÍGITOS</h3>
                <button class="btn-clear" onclick="clearDigits()">Limpar</button>
            </div>
            <div class="digits-display" id="digitsDisplay"></div>
        </div>

        <!-- Logs -->
        <div class="logs-section">
            <div class="logs-header">
                <h3>LOGS DO SISTEMA</h3>
                <div class="logs-actions">
                    <button class="btn-download" onclick="downloadFullLog()">Logs</button>
                    <button class="btn-download" onclick="downloadSequenceReport()">Sequências</button>
                    <button class="btn-clear" onclick="clearLogs()">Limpar</button>
                </div>
            </div>
            <div class="logs-container" id="logsContainer"></div>
        </div>
    </div>

    <!-- PAINEL DIREITO -->
    <div class="right-panel">
        <div class="panel-section">
            <div class="section-title">Estatísticas</div>
            <!-- Lucro/Prejuízo -->
            <div class="panel-section">
                <div class="section-title">Lucro/Prejuízo</div>
                <div class="value-display" id="profitDisplay">$0.00</div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="winsCount">0</div>
                    <div class="stat-label">Vitórias</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lossesCount">0</div>
                    <div class="stat-label">Derrotas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTradesStats">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="winRateStats">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
            </div>
            <button class="btn btn-reset" onclick="resetStats()">Reset Estatísticas</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let botState = {};
    let currentConfig = {};
    let availableStrategies = {};
    let currentStrategySchema = {};
    let currentTradingModes = {};
    let selectedModeSettings = {};

    socket.on('botStateUpdate', (state) => {
        botState = state;
        updateInterface();
    });

    socket.on('configUpdate', (config) => {
        currentConfig = config;
        updateConfigInterface();
        updateInterface();
    });

    socket.on('strategiesUpdate', (strategies) => {
        availableStrategies = strategies;
        updateStrategySelector();
    });

    socket.on('currentStrategyInfo', (info) => {
        updateStrategyInfo(info);
    });

    socket.on('newLog', (log) => {
        addLogToInterface(log);
    });

    socket.on('downloadFile', (fileData) => {
        downloadFile(fileData.filename, fileData.content, fileData.type);
    });

    socket.on('connect', () => {
        socket.emit('get_config');
        socket.emit('get_strategies');
    });

    function changeSymbol() {
        const newSymbol = document.getElementById('symbolSelector').value;
        socket.emit('update_config', { symbol: newSymbol });
        clearDigits(); // Clear digits immediately on client side when changing symbol
    }

    function updateInterface() {
        // Conexão
        const statusEl = document.getElementById('connectionStatus');
        if (botState.connected) {
            statusEl.textContent = 'Conectado';
            statusEl.className = 'connection-status connected';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
        } else {
            statusEl.textContent = 'Desconectado';
            statusEl.className = 'connection-status disconnected';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
        }

        // Saldo
        const balance = (botState.balance || 0).toFixed(2);
        document.getElementById('navBalance').textContent = `$${balance}`;

        // Lucro/Prejuízo
        const profitEl = document.getElementById('profitDisplay');
        const profit = botState.stats?.profit || 0;
        profitEl.textContent = `$${profit.toFixed(2)}`;
        profitEl.className = profit >= 0 ? 'value-display positive' : 'value-display negative';

        // Estatísticas
        document.getElementById('winsCount').textContent = botState.stats?.wins || 0;
        document.getElementById('lossesCount').textContent = botState.stats?.losses || 0;
        document.getElementById('totalTradesStats').textContent = botState.stats?.totalTrades || 0;
        
        const totalTrades = botState.stats?.totalTrades || 0;
        const wins = botState.stats?.wins || 0;
        const winRate = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(1) : 0;
        document.getElementById('winRateStats').textContent = `${winRate}%`;

        // Dígitos
        console.log('botState.lastDigits on updateInterface:', botState.lastDigits);
        const digitsContainer = document.getElementById('digitsDisplay');
        digitsContainer.innerHTML = '';
        if (botState.lastDigits && botState.lastDigits.length > 0) {
            botState.lastDigits.forEach(digit => {
                const digitEl = document.createElement('div');
                digitEl.className = `digit ${digit % 2 === 0 ? 'even' : 'odd'}`;
                digitEl.textContent = digit;
                digitsContainer.appendChild(digitEl);
            });
        }
    }

    function updateStrategySelector() {
        const selector = document.getElementById('strategySelector');
        selector.innerHTML = '<option value="">Selecione</option>';
        
        Object.keys(availableStrategies).forEach(strategyName => {
            const option = document.createElement('option');
            option.value = strategyName;
            option.textContent = availableStrategies[strategyName].name || strategyName;
            selector.appendChild(option);
        });

        if (currentConfig.strategy) {
            selector.value = currentConfig.strategy;
        }
    }

    function updateConfigInterface() {
        if (currentConfig.symbol) {
            document.getElementById('symbolSelector').value = currentConfig.symbol;
        }

        if (currentConfig.strategy && availableStrategies[currentConfig.strategy]) {
            generateStrategyConfigFields(currentConfig.strategy);
        }
    }

    function updateStrategyInfo(info) {
        currentStrategySchema = info.schema || {};
        currentTradingModes = info.tradingModes || {};
        generateStrategyConfigFields(currentConfig.strategy);
        updateTradingModesUI();
    }

    function updateTradingModesUI() {
        const container = document.getElementById('tradingModesContainer');
        const selector = document.getElementById('tradingModeSelector');
        
        selector.innerHTML = ''; // No "Manual" option

        if (Object.keys(currentTradingModes).length > 0) {
            container.style.display = 'block';
            for (const modeName in currentTradingModes) {
                const option = document.createElement('option');
                option.value = modeName;
                option.textContent = modeName;
                selector.appendChild(option);
            }
        } else {
            container.style.display = 'none';
        }
    }

    function changeTradingMode() {
        const selectedMode = document.getElementById('tradingModeSelector').value;
        if (selectedMode && currentTradingModes[selectedMode]) {
            selectedModeSettings = currentTradingModes[selectedMode];
        } else {
            selectedModeSettings = {};
        }
    }

    function generateStrategyConfigFields(strategyName) {
        // This function is now obsolete, as dynamic fields are not displayed.
        const container = document.getElementById('strategyConfigFields');
        container.innerHTML = '';
        container.style.display = 'none';
    }

    function changeStrategy() {
        const selectedStrategy = document.getElementById('strategySelector').value;
        console.log('Mudando estratégia para:', selectedStrategy);
        if (selectedStrategy) {
            socket.emit('change_strategy', selectedStrategy);
        }
    }

    function addLogToInterface(log) {
        const logsContainer = document.getElementById('logsContainer');
        const logEl = document.createElement('div');
        logEl.className = `log-entry ${log.type}`;
        logEl.innerHTML = `<strong>${log.timestamp}</strong> ${log.message}`;
        logsContainer.insertBefore(logEl, logsContainer.firstChild);

        while (logsContainer.children.length > 50) {
            logsContainer.removeChild(logsContainer.lastChild);
        }
    }



    function clearLogs() {
        document.getElementById('logsContainer').innerHTML = '';
    }

    function clearDigits() {
        socket.emit('clear_digits');
    }

    function connectBot() {
        const token = 'NSZPzUBXPi37dnV'; 
        socket.emit('connect_bot', token);
    }

    function startBot() {
        // Atualizar configurações antes de iniciar
        const config = {};
        
        // Read common fields
        config.baseStake = parseFloat(document.getElementById('baseStake').value) || 0.35;
        config.multiplier = parseFloat(document.getElementById('riskManagement').value) || 2.2;
        config.maxMartingale = parseInt(document.getElementById('maxMartingale').value) || 6;
        config.profitGoal = parseFloat(document.getElementById('profitGoal').value) || 0;
        
        // Add selected mode settings
        Object.assign(config, selectedModeSettings);

        config.symbol = document.getElementById('symbolSelector').value;

        socket.emit('update_config', config);
        socket.emit('start_bot');
    }

    function stopBot() {
        socket.emit('stop_bot');
    }

    function downloadFile(filename, content, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    function downloadFullLog() {
        socket.emit('download_full_log');
    }

    function downloadSequenceReport() {
        socket.emit('download_sequence_report');
    }

    function resetStats() {
        if (confirm('Tem certeza que deseja resetar todas as estatísticas?')) {
            socket.emit('reset_stats');
        }
}

updateInterface();
</script>
</body>
</html>